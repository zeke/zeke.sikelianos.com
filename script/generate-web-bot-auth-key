#!/usr/bin/env node

// Generate an Ed25519 keypair for Web Bot Auth
// Outputs a JSON object with both public and private key in JWK format
// Usage: node script/generate-web-bot-auth-key

const crypto = require('crypto')

async function generateKey () {
  // Generate Ed25519 keypair
  const { publicKey, privateKey } = await crypto.subtle.generateKey(
    { name: 'Ed25519' },
    true, // extractable
    ['sign', 'verify']
  )

  // Export keys in JWK format
  const publicJwk = await crypto.subtle.exportKey('jwk', publicKey)
  const privateJwk = await crypto.subtle.exportKey('jwk', privateKey)

  // Strip algorithm-specific fields that cause issues with web-bot-auth
  // The library expects only kty, crv, x, d (for private) fields
  const minimalPrivateJwk = {
    kty: privateJwk.kty,
    crv: privateJwk.crv,
    x: privateJwk.x,
    d: privateJwk.d
  }

  console.log('=== Web Bot Auth Ed25519 Key ===\n')

  console.log('Public JWK (for JWKS directory):')
  console.log(JSON.stringify({
    kty: publicJwk.kty,
    crv: publicJwk.crv,
    x: publicJwk.x
  }, null, 2))

  console.log('\nPrivate JWK (for signing - keep secret!):')
  console.log(JSON.stringify(minimalPrivateJwk, null, 2))

  console.log('\n=== Wrangler Secret Commands ===\n')
  console.log('Run this command to set the signing key as a Worker secret:')
  console.log(`echo '${JSON.stringify(minimalPrivateJwk)}' | npx wrangler secret put WEB_BOT_AUTH_KEY`)
}

generateKey().catch(console.error)
